<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장바구니</title>
    <link rel="shortcut icon" th:href="@{/images/fav.ico}" type="image/x-icon">
    <link rel="stylesheet" th:href="@{/css/reset.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/style_cart.css}">
    <script>
        window.onload = function(){

            const counts = document.getElementsByClassName('count');
            const discounts = document.getElementsByClassName('discount');
            const prices = document.getElementsByClassName('price'); //할인된 가격
            const points = document.getElementsByClassName('point'); //적립되는 포인트
            const select_points = document.getElementsByClassName('select_point'); //적립 포인트률
            const totals = document.getElementsByClassName('total'); //소계

            const btnDelete = document.getElementById('btnDelete');


            // 적립 포인트 비율 숨기기
            for(let i = 0; i<counts.length; i++) {
                select_points[i].style.display = 'none';

                const count = parseInt(counts[i].textContent) || 0; //갯수
                const price = parseFloat(prices[i].textContent) || 0; //할인된 가격
                const select_point = parseFloat(select_points[i].textContent) || 0; //적립되는 포인트률
                const discount = parseFloat(discounts[i].textContent) || 0; // 나중에 쓸 것 같아서..


                //적립되는 포인트 계산
                const total_point = Math.floor(price * (select_point / 100) * count);
                points[i].textContent = total_point + 'p';

                //소계
                const total = (price * count);
                totals[i].textContent = total.toLocaleString() + '원';
                totals[i].style.fontWeight = 'bold';

            }



            //제목줄 체크박스
            const checkAll = document.querySelector('.checkbox');
            //제목줄 제외 체크박스
            //const checks = document.querySelectorAll('.checkboxes');

            //1. 제목줄 체크박스 클릭시
            checkAll.addEventListener('click', function(){
                const isChecked = checkAll.checked; // 제목줄 체크, 체크여부 변수
                const checkBoxes = document.querySelectorAll('.checkboxes'); //제목줄 제외 체크박스

                // 전체선택
                if(isChecked){
                    for(const checkBox of checkBoxes){
                        checkBox.checked = true;
                        updateTotal();
                    }
                // 전체해제
                }else {
                    for(const checkBox of checkBoxes){
                        checkBox.checked = false;
                        updateTotal();
                    }
                }
            })

            //2. 선택항목 체크박스 클릭시 제목줄 체크박스 업데이트
            const checkBoxes = document.querySelectorAll('.checkboxes');

            checkBoxes.forEach(checkBox => {
                checkBox.addEventListener('click' , function (){
                    const checkCount = document.querySelectorAll('.checkboxes:checked').length;
                    if(checkCount === checkBoxes.length){
                        checkAll.checked = true;
                    }else {
                        checkAll.checked = false;
                    }
                })
            })




            // 선택한 체크박스 삭제
            btnDelete.onclick = function(e){
                e.preventDefault();

                const checks = document.querySelectorAll('.checkboxes:checked');

                if(checks.length === 0){
                    alert('삭제할 항목을 선택하세요.');
                    return;
                }
                const data = Array.from(checks).map(checkbox => checkbox.value);

                fetch('/farmstory/market/cart/delete',{
                    method : 'DELETE',
                    headers : {'Content-Type' : 'application/json'},
                    body : JSON.stringify(data)
                })
                    .then(resp =>
                    {
                        if(resp.ok == false){
                             throw new Error("실패")
                        }
                        alert('성공');
                        checks.forEach(checkbox => {
                            const tr = checkbox.closest('tr');
                            if(tr){
                                tr.remove();
                            }
                        })

                        // // 삭제 후 빈 상태 메시지 표시
                        // const restbox = document.querySelectorAll('table.tb1 tr').length - 1; // 남은 체크박스 수
                        // if (restbox === 0) {
                        //     document.getElementById('empty').style.display = 'table-row'; // 메시지 보여주기
                        // }

                    })
                    .catch(err => {
                        console.log(err);
                        alert('오류발생');
                    })

            } //체크박스 삭제 끝

            // 합계 계산
            function updateTotal() {
                const checks = document.querySelectorAll('.checkboxes:checked');
                let totalCount = 0; //상품수
                let totalProduct = 0; //상품금액
                let totalDiscount = 0; //할인금액
                let totalDeliveryFee = 0; // 배송비
                let totalPoint = 0; // 포인트
                let resultPrice = 0;


                checks.forEach(checkBox => {
                    const tr = checkBox.closest('tr');
                    if (tr) {

                        const count = parseInt(tr.querySelector('.count').textContent) || 0;
                        const discount = parseInt(tr.querySelector('.discount').textContent) || 0; //할인율
                        const price = parseInt(tr.querySelector('.price').textContent) || 0;
                        const orgPrice = parseInt(tr.querySelector('.org_price').textContent) || 0;
                        let delivery = parseInt(tr.querySelector('.deliveryFee').textContent) || 0;
                        const etc = parseInt(tr.querySelector('.etc').textContent) || 0;

                        totalCount += count;
                        totalProduct += orgPrice * count; //상품가격
                        totalDiscount += (discount * orgPrice / 100) * count; //할인받는 가격
                        totalPoint += Math.floor(price * (parseFloat(tr.querySelector('.select_point').textContent) / 100) * count); // 포인트 계산
                        let totalPrice = ((orgPrice * count) - ((discount * orgPrice / 100) * count)); // 소계



                        if(totalPrice >= etc){
                            delivery = 0;
                        } {
                            totalDeliveryFee += delivery;
                        }
                        resultPrice += totalPrice + delivery;
                    }
                })
                // dom 업뎃
                document.querySelector('.product_delivery_fee').textContent = totalDeliveryFee.toLocaleString()+'원';
                document.querySelector('.product_count').textContent = totalCount;
                document.querySelector('.product_price').textContent = totalProduct.toLocaleString()+'원';
                document.querySelector('.product_discount').textContent = totalDiscount.toLocaleString()+'원';
                document.querySelector('.product_point').textContent = totalPoint.toLocaleString()+'원';
                document.querySelector('.product_total').textContent = resultPrice.toLocaleString()+'원';

            }

                //체크박스 클릭시 합계 업데이트
                const checkBoxUpdate = document.querySelectorAll('.checkboxes');
                checkBoxUpdate.forEach(checkBox => {
                    checkBox.addEventListener('click' , updateTotal);
                });











        } //onload 끝

    </script>
</head>
<body>

<th:block th:include ="./include/header.html"/>

<!-- #main -->
<main id="main" class="cf">
    <section class="mainIn cf">
        <div class="sub_bg">
            <img src="../images/sub_top_tit2.png" alt="MARKET" class="sub_tit">
        </div><!-- .sub_bg -->

        <aside class="aside">
            <div class="sidebar">
                <div class="aside_cate">
                    <img src="../images/sub_aside_cate2_tit.png" alt="Buying in the Market 장보기">
                </div><!-- .aside_cate -->
                <div class="aside_bg">
                    <ul class="cate_lnb">
                        <li> <a href="#">장보기</a></li>
                    </ul><!-- .cate_lnb -->
                </div><!-- .aside_bg -->
            </div><!-- .sidebar -->
        </aside><!-- .aside -->
        <article class="article">
            <div class="articleIn cf">
                <nav>
                    <h2><img src="../images/sub_nav_tit_cate2_tit1.png" alt="장보기"></h2>
                    <p class="location">
                        <img src="../images/sub_page_nav_ico.gif" alt="메뉴">
                        <span>HOME </span>
                        <span>장보기 </span>
                        <strong>장보기</strong>
                    </p><!-- .location -->
                </nav>

                <h3 class="tb_tit" th:text ="'장바구니 전체('+${count}+')'">장바구니 전체(10)</h3><!-- .tb_tit -->
                <table class="tb1">
                    <colgroup>
                        <col style="width: 11%">
                        <col style="width: 5%">
                        <col style="width: 10%">
                        <col style="width: 15%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                    </colgroup>
                    <tr>
                        <th><input type="checkbox" class="checkbox"/></th>
                        <th>이미지</th>
                        <th>종류</th>
                        <th>상품명</th>
                        <th>수량</th>
                        <th>할인</th>
                        <th>포인트</th>
                        <th>가격</th>
                        <th>소계</th>
                    </tr>
                    <tr th:if="${cart == null or #lists.isEmpty(cart)}">
                        <td colspan="9" id="empty" class="td_first" >장바구니에 상품이 없습니다.</td>
                    </tr>
                    <tr th:each="carts:${cart}" th:if="${cart != null and !#lists.isEmpty(cart)}">
                        <td><input type="checkbox" class="checkboxes" th:attr="value=${carts.cartNO}"/></td>
                        <td><img th:src="@{'/productImg/'+${carts.product.img1}}" alt="사과샘플" /></td>
                        <td th:text="${carts.product.type}"></td>
                        <td class="prodName" th:text="${carts.product.prodName}">사과 500g</td>
                        <td class="count" th:text="${carts.count}"></td>
                        <td class="deliveryFee" th:text="${carts.product.deliveryfee}">배송비</td>
                        <td class="etc" th:text="${carts.product.etc}">이상무료배송</td>
                        <td class="discount" th:text="${carts.product.discount} + '%'"></td>
                        <td class="point"></td>
                        <td class="select_point" th:text="${carts.product.point}"></td>
                        <td>
                            <span class="org_price" th:text="${carts.product.price}"></span><br>
                            <span class="price">[[${carts.product.price - carts.product.price * carts.product.discount / 100}]]</span>원
                        </td>
                        <td class="total"></td>
                    </tr>
                </table><!-- .tb1 -->
                <button class="btnSD" id="btnDelete"><a th:href="@{/market/delete}">선택삭제</a></button>
                <div class="order_final">
                    <table class="tb2">
                        <tr>
                            <th colspan="2">전체합계</th>
                        </tr>
                        <tr>
                            <td>상품수</td>
                            <td class="product_count">0원</td>
                        </tr>
                        <tr>
                            <td>상품금액</td>
                            <td class="product_price">0원</td>
                        </tr>
                        <tr>
                            <td>할인금액</td>
                            <td class="product_discount">0원</td>
                        </tr>
                        <tr>
                            <td>배송비</td>
                            <td class="product_delivery_fee">0원</td>
                        </tr>
                        <tr>
                            <td>포인트</td>
                            <td class="product_point">0원</td>
                        </tr>
                        <tr>
                            <td>전체주문금액</td>
                            <td class="product_total">0원</td>
                        </tr>
                    </table><!-- .tb2 -->
                    <button class="btn_order"><a th:href="@{/market/order}">주문하기</a></button>
                </div><!-- .order_final -->

            </div><!-- .articleIn -->
        </article><!-- .article -->
    </section>
</main><!-- #main -->

<footer id="footer">
    <div class="footerIn cf">
        <img src="../images/footer_logo.png" alt="farmStory footer" class="flogo">
        <div class="finfo">
            <span class="tel">(주)팜스토리 / 사업자등록번호 123-45-67890 / 통신판매업신고 제 2013-팜스토리구-123호 / 벤처기업확인 서울지방중소기업청 제 012345678-9-01234호<br>
                등록번호 팜스토리01234 (2013.04.01) / 발행인 : 홍길동 <br>
                대표 : 홍길동 / 이메일 : email@mail.mail / 전화 : 01&#41; 234-5678 / 경기도 성남시 잘한다구 신난다동 345
            </span><!-- .tel -->
            <p class="fcopy">Copyright(C)홍길동 All rights reserved.</p><!-- .fcopy -->
        </div><!-- .finfo -->
    </div><!-- .footerIn -->
</footer><!-- footer -->
</body>
</html>
